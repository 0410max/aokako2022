<div class='container rooms-index-wrapper'>
    <div class='row'>
        <div class='col-md-4 offset-1 rooms-index-left'>
            <% @rooms.each do |room| %>
                <%= link_to room_path(room),class:'rooms-show-link' do %>
                    <% if room.id == @room.id %>
                        <div class='rooms-content-at'>
                            <% @RoomUsers = room.room_users %>
                            <% @RoomUsers.each do |r| %>
                                <% unless r.end_user.name === current_end_user.name %>
                                    <%= image_tag r.end_user.get_profile_image,size:'40x40',class:'rooms-index-profile-image' %>
                                    <span class='rooms-index-top-name'>
                                        <%= r.end_user.name %>
                                    </span><br />
                                    <% if Message.find_by(id: room.messages).present? %>
                                        <% if Message.find_by(id: room.messages.last).message.length > 10 %>
                                            <span class='last-message'><%= Message.find_by(id: room.messages.last).message[0..10] %>...&nbsp;&nbsp;
                                            <%= time_ago_in_words(Message.find_by(id: room.messages.last).created_at).upcase %>前</span>
                                        <% else %>
                                            <span class='last-message'><%= Message.find_by(id: room.messages.last).message %>&nbsp;&nbsp;
                                            <%= time_ago_in_words(Message.find_by(id: room.messages.last).created_at).upcase %>前</span>
                                        <% end %>
                                    <% end %>
                                <% end %>
                            <% end %>
                        </div>
                    <% else %>
                        <div class='rooms-content'>
                            <% @RoomUsers = room.room_users %>
                            <% @RoomUsers.each do |r| %> 
                                <% unless r.end_user.name === current_end_user.name %>
                                    <%= image_tag r.end_user.get_profile_image,size:'40x40',class:'rooms-index-profile-image' %>
                                    <span class='rooms-index-top-name'>
                                        <%= r.end_user.name %>
                                    </span><br />
                                    <% if Message.find_by(id: room.messages).present? %>
                                        <% if Message.find_by(id: room.messages.last).message.length > 10 %>
                                            <span class='last-message'><%= Message.find_by(id: room.messages.last).message[0..10] %>...&nbsp;&nbsp;
                                            <%= time_ago_in_words(Message.find_by(id: room.messages.last).created_at).upcase %>前</span>
                                        <% else %>
                                            <span class='last-message'><%= Message.find_by(id: room.messages.last).message %>&nbsp;&nbsp;
                                            <%= time_ago_in_words(Message.find_by(id: room.messages.last).created_at).upcase %>前</span>
                                        <% end %>
                                    <% end %>
                                <% end %>
                            <% end %>
                        </div>
                    <% end %>
                <% end %>
            <% end %>
        </div>
        <div class='col-md-6 rooms-index-right'>
            <div class='rooms-index-right-top'>
                <% @RoomUsers = @room.room_users %>
                <% @RoomUsers.each do |r| %>
                    <% unless r.end_user.name === current_end_user.name %>
                        <%= link_to end_user_path(r),class:'rooms-show-end-user-link' do %>
                            <span class='rooms-show-top-name'>
                                <%= r.end_user.name %>
                            </span>
                        <% end %>
                    <% end %>
                <% end %>
            </div>
            <div class='message-area-wrapper'>
                <div class='message-area'>
                <% if @messages.present? %>
                    <div class='message-wrapper'>
                        <% @messages.each do |m| %>
                            <div class='message-content-wrapper'>
                                <% if m.end_user_id == current_end_user.id %>
                                    <div class='current_user-wrapper'>
                                        <div class="current_user">
                                            <div class='current_user-width'><%= safe_join(m.message.split("\n"),tag(:br)) %></div>
                                            <span class='current_user-time'><%= m.created_at.strftime("%-m/%-d %-H:%S") %></span>
                                        </div>
                                    </div>
                                <% else %>
                                    <div class='visited_user-wrapper'>
                                        <%= link_to end_user_path(m.end_user) do %>
                                            <%= image_tag m.end_user.get_profile_image,size:'30x30',class:'message-profile-image' %>
                                        <% end %>
                                        <div class="visited_user fukidasi">
                                            <div class='visited_user-width'><%= safe_join(m.message.split("\n"),tag(:br)) %></div>
                                            <span class='visited_user-time'><%= m.created_at.strftime("%-m/%-d %-H:%S") %></span>
                                        </div>
                                    </div>
                                <% end %>
                            </div>
                        <% end %>   
                    </div>
                <% else %>
                    <p class='no-dm-message'>メッセージはまだありません</p>
                <% end %>
            </div>
            <div class='rooms-show-form'>
                <%= form_with model: @message do |f| %>
                    <%= f.text_area :message, placeholder: "メッセージを入力してください",class:'message-text-area' %>
                    <%= f.hidden_field :room_id, value: @room.id %>
                    <%= f.submit '送信',class:'message-submit' %>
                <% end %>
            </div>
            </div>
        </div>
    </div>
</div>
